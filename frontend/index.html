<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CS2 Market assistant</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: "Inter", "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #020617; color: #e2e8f0; min-height: 100%; display: flex; flex-direction: column; }
    body::-webkit-scrollbar { width: 10px; }
    body::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 999px; }
    .background { position: fixed; inset: 0; background: radial-gradient(circle 480px at 20% 20%, #2563eb44, transparent 60%), radial-gradient(circle 420px at 80% 0%, #a855f744, transparent 60%), radial-gradient(circle 520px at 50% 100%, #22d3ee33, transparent 60%); filter: blur(40px); opacity: 0.9; z-index: 0; }
    .app-shell { position: relative; z-index: 1; max-width: 1280px; margin: 0 auto; padding: 32px 24px 48px; display: flex; flex-direction: column; gap: 28px; flex: 1; min-height: 0; }
    .topbar { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 24px; padding: 20px 24px; border-radius: 20px; background: linear-gradient(135deg, #0f172aee, #0b1120f2); border: 1px solid #1f2937; backdrop-filter: blur(20px); box-shadow: 0 30px 80px -50px #1d4ed885; }
    .brand { display: flex; align-items: center; gap: 16px; }
    .logo { display: grid; place-items: center; width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(135deg, #2563eb, #7c3aed); font-size: 22px; font-weight: 700; }
    .brand-text h1 { margin: 0; font-size: 1.24rem; font-weight: 600; letter-spacing: 0.01em; }
    .brand-text p { margin: 4px 0 0; color: #94a3b8; font-size: 0.9rem; }
    .topbar-actions { display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap; justify-content: flex-end; }
    .status-pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; background: #0f172a; border: 1px solid #1f2937; font-size: 0.85rem; color: #cbd5f5; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #fbbf24; box-shadow: 0 0 0 2px #fbbf2422; transition: background 0.3s ease; }
    .status-dot.status-online { background: #34d399; box-shadow: 0 0 0 2px #34d39933; }
    .status-dot.status-offline { background: #f87171; box-shadow: 0 0 0 2px #f8717133; }
    .status-dot.status-checking { background: #fbbf24; }
    .api-field { display: flex; flex-direction: column; gap: 6px; min-width: 240px; }
    .api-field label { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; }
    .api-field input { padding: 10px 14px; border-radius: 12px; border: 1px solid #1f2937; background: #020817; color: inherit; outline: none; transition: border 0.2s ease, background 0.2s ease; }
    .api-field input:focus { border-color: #2563eb; background: #040b1d; }
    .ghost-btn { padding: 10px 14px; border-radius: 12px; border: 1px solid #1f2937; background: #101a2f; color: #cbd5f5; cursor: pointer; font: inherit; transition: all 0.2s ease; }
    .ghost-btn:hover { border-color: #2563eb; color: #fff; background: #1d2b46; }
    .surface { flex: 1; display: flex; gap: 24px; align-items: stretch; min-height: 0; }
    .chat-pane { flex: 1; display: flex; flex-direction: column; min-height: 0; background: #030712cc; border: 1px solid #1f2937; border-radius: 24px; backdrop-filter: blur(16px); box-shadow: 0 40px 120px -70px #000; }
    .chat-scroll { flex: 1; min-height: 0; overflow-y: auto; padding: 28px; display: flex; flex-direction: column; gap: 20px; }
    .chat-scroll::-webkit-scrollbar { width: 6px; }
    .chat-scroll::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 999px; }
    .message { display: flex; gap: 16px; align-items: flex-start; }
    .message--user { flex-direction: row-reverse; }
    .message--assistant .avatar { background: linear-gradient(160deg, #2563eb, #06b6d4); }
    .message--user .avatar { background: linear-gradient(160deg, #22d3ee, #0ea5e9); }
    .avatar { width: 44px; height: 44px; border-radius: 50%; display: grid; place-items: center; font-size: 20px; font-weight: 600; box-shadow: 0 10px 30px -18px rgba(0,0,0,0.6); }
    .bubble { max-width: min(72ch, 100%); padding: 16px 18px; border-radius: 18px; font-size: 0.98rem; line-height: 1.62; background: #0b1120; border: 1px solid #1f2937; box-shadow: inset 0 0 0 1px rgba(37,99,235,0.04); backdrop-filter: blur(20px); }
    .message--user .bubble { background: linear-gradient(135deg, #1f2937, #111827); border-color: #1e3a8a; text-align: right; }
    .bubble strong { color: #facc15; }
    .bubble code { background: #1e293b; padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.85rem; }
    .typing { display: inline-flex; gap: 6px; align-items: center; }
    .typing span { width: 6px; height: 6px; border-radius: 999px; background: #94a3b8; animation: typing 1s infinite ease-in-out; opacity: 0.7; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 80%, 100% { transform: translateY(0); opacity: 0.4; } 40% { transform: translateY(-4px); opacity: 1; } }
    .composer { margin: 0; padding: 22px 24px 24px; border-top: 1px solid #1f2937; background: linear-gradient(0deg, #030712, rgba(3,7,18,0.6)); display: flex; flex-direction: column; gap: 14px; flex-shrink: 0; position: sticky; bottom: 0; }
    .input-wrapper { display: flex; background: #020617; border: 1px solid #1e293b; border-radius: 18px; padding: 12px 16px; transition: border 0.2s ease; }
    .input-wrapper:focus-within { border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37,99,235,0.05); }
    textarea { width: 100%; border: none; background: transparent; resize: none; color: inherit; font: inherit; line-height: 1.6; max-height: 220px; }
    textarea:focus { outline: none; }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    .hint { font-size: 0.8rem; color: #64748b; }
    .action-group { display: flex; gap: 10px; flex-shrink: 0; }
    .primary-btn { padding: 10px 20px; border-radius: 14px; border: none; background: linear-gradient(135deg, #2563eb, #7c3aed); color: #fff; font-weight: 600; letter-spacing: 0.02em; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease; }
    .primary-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .primary-btn:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 12px 32px -16px #2563ebcc; }
    .inspector { display: none; flex-direction: column; flex: 0 0 340px; width: 340px; min-height: 0; background: #030712cc; border: 1px solid #1f2937; border-radius: 24px; backdrop-filter: blur(18px); box-shadow: 0 40px 120px -80px #000; overflow: hidden; }
    .inspector.is-open { display: flex; }
    .inspector-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px 0; }
    .inspector-header h2 { margin: 0; font-size: 1rem; font-weight: 600; }
    .inspector-header p { margin: 6px 0 0; color: #8b9cb6; font-size: 0.82rem; }
    .events-list { list-style: none; margin: 0; padding: 18px 24px 24px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .events-list::-webkit-scrollbar { width: 6px; }
    .events-list::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 999px; }
    .event-card { border: 1px solid #1f2937; border-radius: 16px; padding: 14px 16px; background: #050b1c; display: flex; flex-direction: column; gap: 8px; }
    .event-header { display: flex; align-items: center; justify-content: space-between; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 0.72rem; letter-spacing: 0.05em; text-transform: uppercase; }
    .badge-thought { background: rgba(96, 165, 250, 0.16); color: #93c5fd; }
    .badge-action { background: rgba(52, 211, 153, 0.16); color: #6ee7b7; }
    .badge-observation { background: rgba(250, 204, 21, 0.14); color: #fde68a; }
    .badge-final { background: rgba(244, 114, 182, 0.16); color: #f472b6; }
    .event-step { color: #64748b; font-size: 0.78rem; }
    .event-body { color: #e2e8f0; white-space: pre-wrap; font-size: 0.88rem; line-height: 1.5; }
    .empty { color: #64748b; font-size: 0.85rem; text-align: center; padding: 24px 12px; border: 1px dashed #1f2937; border-radius: 16px; }
    @media (max-width: 1100px) { .surface { flex-direction: column; } .inspector { position: fixed; bottom: 32px; right: 32px; width: min(420px, calc(100% - 32px)); max-height: 70vh; display: none; border-radius: 20px; border: 1px solid #1e293b; background: #020817ee; } .inspector.is-open { display: flex; animation: inspectorFade 0.2s ease forwards; } @keyframes inspectorFade { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } } }
    @media (max-width: 780px) { .app-shell { padding: 24px 16px 32px; } .topbar { padding: 18px; } .api-field { min-width: unset; width: 100%; } .surface { gap: 18px; } .chat-scroll { padding: 22px 18px; } .chat-pane { border-radius: 20px; } .composer-actions { flex-direction: column; align-items: stretch; gap: 12px; } .action-group { width: 100%; justify-content: flex-end; } }
  </style>
</head>
<body>
  <div class="background"></div>
  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <span class="logo">CS2</span>
        <div class="brand-text">
          <h1>CS2 Market Copilot</h1>
          <p>CS2-AI助手 ReAct 推理驱动</p>
        </div>
      </div>
      <div class="topbar-actions">
        <div class="status-pill" id="statusPill">
          <span class="status-dot status-offline" id="statusDot"></span>
          <span id="statusText">未连接</span>
        </div>
        <div class="api-field">
          <label for="apiBase">API 地址</label>
          <input id="apiBase" type="url" placeholder="http://127.0.0.1:8000" />
        </div>
        <button type="button" class="ghost-btn" id="toggleInspector">推理视图</button>
      </div>
    </header>

    <main class="surface">
      <section class="chat-pane">
        <div class="chat-scroll" id="chatList"></div>
        <form id="composerForm" class="composer">
          <div class="input-wrapper">
            <textarea id="questionInput" rows="1" placeholder="向饰品助手提问，例如：'蝴蝶刀 渐变 久经 价格' 或 '查询玩家库存 7656...'" autocomplete="off"></textarea>
          </div>
          <div class="composer-actions">
            <span class="hint">Shift + Enter 换行</span>
            <div class="action-group">
              <button type="button" id="newChatBtn" class="ghost-btn">新对话</button>
              <button type="submit" id="askBtn" class="primary-btn">发送</button>
            </div>
          </div>
        </form>
      </section>

      <aside class="inspector" id="inspector">
        <div class="inspector-header">
          <div>
            <h2>推理轨迹</h2>
            <p>实时洞察 Thought · Action · Observation</p>
          </div>
          <button type="button" class="ghost-btn" id="closeInspector" style="width:30px;height:30px;padding:0;font-size:15px;">×</button>
        </div>
        <ul class="events-list" id="eventsList">
          <li class="empty">尚未开始对话</li>
        </ul>
      </aside>
    </main>
  </div>

  <script>
    const chatList = document.getElementById('chatList');
    const eventsList = document.getElementById('eventsList');
    const questionInput = document.getElementById('questionInput');
    const composerForm = document.getElementById('composerForm');
    const askBtn = document.getElementById('askBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const apiBaseInput = document.getElementById('apiBase');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const inspector = document.getElementById('inspector');
    const toggleInspectorBtn = document.getElementById('toggleInspector');
    const closeInspectorBtn = document.getElementById('closeInspector');
    const mediaQuery = window.matchMedia('(min-width: 1100px)');

    let apiBase = '';
    let inFlight = false;
    let sseController = null;
    
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderText(text) {
      return escapeHtml(text).replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
    }

    function renderTyping() {
      return '<span class="typing"><span></span><span></span><span></span></span>';
    }

    function appendMessage(role, htmlContent) {
      const wrapper = document.createElement('article');
      wrapper.className = 'message message--' + role;
      const avatarSymbol = role === 'user' ? '你' : 'AI';
      wrapper.innerHTML = `
        <div class="avatar">${avatarSymbol}</div>
        <div class="bubble">
          <div class="message-body">${htmlContent}</div>
        </div>
      `;
      chatList.appendChild(wrapper);
      chatList.scrollTop = chatList.scrollHeight;
      return wrapper;
    }

    function renderEvents(events) {
      eventsList.innerHTML = '';
      if (!events || events.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'empty';
        empty.textContent = '暂无推理信息';
        eventsList.appendChild(empty);
        return;
      }

      const frag = document.createDocumentFragment();
      events.forEach((ev, index) => {
        const li = document.createElement('li');
        li.className = 'event-card';

        const header = document.createElement('div');
        header.className = 'event-header';

        const badge = document.createElement('span');
        badge.className = 'badge ' + badgeClass(ev.type);
        badge.textContent = badgeLabel(ev.type);

        const step = document.createElement('span');
        step.className = 'event-step';
        step.textContent = `Step ${ev.step ?? index + 1}`;

        header.appendChild(badge);
        header.appendChild(step);

        const body = document.createElement('div');
        body.className = 'event-body';
        body.innerHTML = renderEventBody(ev);

        li.appendChild(header);
        li.appendChild(body);
        frag.appendChild(li);
      });

      eventsList.appendChild(frag);
      inspector.classList.add('is-open');
    }

    function badgeClass(type) {
      switch (type) {
        case 'thought':
          return 'badge-thought';
        case 'observation':
          return 'badge-observation';
        case 'final':
          return 'badge-final';
        default:
          return 'badge-action';
      }
    }

    function badgeLabel(type) {
      switch (type) {
        case 'thought':
          return 'Thought';
        case 'action':
          return 'Action';
        case 'observation':
          return 'Observation';
        case 'error':
          return 'Error';
        case 'incomplete':
          return 'Incomplete';
        case 'final':
          return 'Final';
        default:
          return type ?? 'Info';
      }
    }

    function renderEventBody(ev) {
      if (!ev || !ev.type) {
        return '—';
      }
      if (ev.type === 'thought') {
        return renderText(ev.thought || '');
      }
      if (ev.type === 'observation') {
        return renderText(ev.observation || '');
      }
      if (ev.type === 'final') {
        return renderText(ev.final_answer || '');
      }
      if (ev.type === 'error') {
        return renderText(ev.message || '执行出错');
      }
      if (ev.type === 'incomplete') {
        return renderText(ev.message || 'Agent 未完成推理');
      }
      if (ev.type === 'action') {
        const action = ev.action || ev.tool || '未知工具';
        const input = ev.action_input || '{}';
        return `<strong>${escapeHtml(action)}</strong><br>${renderText(input)}`;
      }
      return renderText(JSON.stringify(ev));
    }

    function setStatus(state, label) {
      statusDot.classList.remove('status-online', 'status-offline', 'status-checking');
      statusDot.classList.add('status-' + state);
      statusText.textContent = label;
    }

    async function pingHealth() {
      const target = apiBaseInput.value.trim() || 'http://127.0.0.1:8000';
      apiBase = target;
      localStorage.setItem('apiBase', apiBase);
      setStatus('checking', '连接中…');
      try {
        const resp = await fetch(apiBase + '/health', { method: 'GET' });
        if (!resp.ok) {
          throw new Error('HTTP ' + resp.status);
        }
        setStatus('online', '在线');
      } catch (error) {
        setStatus('offline', '未连接');
      }
    }

    async function handleAsk(event) {
      event.preventDefault();
      if (inFlight) {
        return;
      }

      const question = questionInput.value.trim();
      if (!question) {
        return;
      }

      inFlight = true;
      askBtn.disabled = true;

      if (sseController) {
        sseController.abort();
      }

      appendMessage('user', renderText(question));
      questionInput.value = '';
      autoResize();

      const assistantMsg = appendMessage('assistant', renderTyping());
      const assistantBody = assistantMsg.querySelector('.message-body');
      const eventsBuffer = [];
      renderEvents(eventsBuffer);

      try {
        const controller = new AbortController();
        sseController = controller;
        const response = await fetch(apiBase + '/ask/stream?question=' + encodeURIComponent(question), {
          method: 'GET',
          signal: controller.signal,
          headers: { Accept: 'text/event-stream' }
        });

        if (!response.ok || !response.body) {
          throw new Error('HTTP ' + response.status);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        let finalAccum = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          let boundary;
          while ((boundary = buffer.indexOf('\n\n')) !== -1) {
            const raw = buffer.slice(0, boundary);
            buffer = buffer.slice(boundary + 2);
            if (!raw.startsWith('data:')) continue;
            const jsonStr = raw.slice(5).trim();
            if (!jsonStr) continue;
            let payload;
            try {
              payload = JSON.parse(jsonStr);
            } catch (e) {
              continue;
            }
            if (payload.type === 'delta') {
              finalAccum += payload.content || '';
              assistantBody.innerHTML = renderText(finalAccum || renderTyping());
            } else if (payload.type === 'final') {
              assistantBody.innerHTML = renderText(payload.final_answer || finalAccum || '（未得到明确回答）');
            } else {
              if (payload.type === 'thought' || payload.type === 'action' || payload.type === 'observation' || payload.type === 'error' || payload.type === 'incomplete') {
                eventsBuffer.push(payload);
                renderEvents(eventsBuffer);
              }
            }
          }
        }
        setStatus('online', '在线');
      } catch (error) {
        assistantBody.innerHTML = '请求失败：' + escapeHtml(error.message || error);
        setStatus('offline', '未连接');
      } finally {
        sseController = null;
        askBtn.disabled = false;
        inFlight = false;
      }
    }

    function autoResize() {
      questionInput.style.height = 'auto';
      const minHeight = 48;
      const newHeight = Math.min(Math.max(questionInput.scrollHeight, minHeight), 220);
      questionInput.style.height = newHeight + 'px';
    }

    function syncInspector() {
      if (mediaQuery.matches) {
        inspector.classList.add('is-open');
      } else {
        inspector.classList.remove('is-open');
      }
    }

    apiBaseInput.addEventListener('change', pingHealth);
    apiBaseInput.addEventListener('blur', pingHealth);

    toggleInspectorBtn.addEventListener('click', () => {
      inspector.classList.toggle('is-open');
    });

    closeInspectorBtn.addEventListener('click', () => {
      inspector.classList.remove('is-open');
    });

    newChatBtn.addEventListener('click', async () => {
      chatList.innerHTML = '';
      eventsList.innerHTML = '';
      const empty = document.createElement('li');
      empty.className = 'empty';
      empty.textContent = '尚未开始对话';
      eventsList.appendChild(empty);
      questionInput.value = '';
      autoResize();
      appendMessage('assistant', renderText('您好，我是 CS2 市场助手。告诉我您想了解的饰品价格、历史走势或玩家库存信息吧。'));
      if (sseController) {
        sseController.abort();
        sseController = null;
      }
      try {
        await fetch(apiBase + '/reset', { method: 'POST' });
      } catch (error) {
        // ignore reset errors, keep UI state
      }
    });

    mediaQuery.addEventListener('change', syncInspector);

    composerForm.addEventListener('submit', handleAsk);
    questionInput.addEventListener('input', autoResize);
    questionInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        composerForm.dispatchEvent(new Event('submit'));
      }
    });

    const storedBase = localStorage.getItem('apiBase') || 'http://127.0.0.1:8000';
    apiBaseInput.value = storedBase;
    apiBase = storedBase;

    appendMessage('assistant', renderText('您好，我是 CS2 市场助手。告诉我您想了解的饰品价格、历史走势或玩家库存信息吧。'));
    autoResize();
    pingHealth();
    syncInspector();
  </script>
</body>
</html>


